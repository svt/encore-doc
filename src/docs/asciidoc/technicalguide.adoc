== The Concept/Technical Guide

If you are looking for concepts, structures and API descriptions, this part of the documentation is for you.

=== Concepts


=== Workflow


[.text-center]
_The workflow for an Encore Job_

image::img/svt_encore_workflow.png[align="center",width=90%]


1. An Encore Job is created
2. It is offered to a Queuefootnote:[In reality the Encore Job itself is not offered to, or polled from the queue - it is an Object QueueItem, which holds the needed metadata for the Encore Job]. At some point, the Encore Job is picked up from the Queue
3. Metadata needed for the coming transcoding task is gathered - for example, the input file is analyzed, the Profile is read.
4. The transcoding is started - (FFmpeg transcoding starts)
5. Output files are written to the configured destination

.The Encore Job status field will roughly tell the observer where in the workflow it is currently (click to expand)
[%collapsible]
====
[source,kotlin]
----
include::https://raw.githubusercontent.com/svt/encore/master/src/main/kotlin/se/svt/oss/encore/model/Status.kt[]
----
====

==== Encore Job

_An *Encore* Job is the aggregate for the information needed to transcode an input file - information like input files, *profile* and priority._

* An *Encore* Job describes how an input file should be processed.
* An *Encore* Job can have several output files, and one input file.
* An *Encore* Job has a *_profile_*, which essentially describes how the job should configure it's transcoding.
* An *Encore* Job has a priority, which essentially describes how the job should be prioritized.

==== Profile

_A *Profile* can be seen as a general abstraction of an FFmpeg configuration - example, bitrate to use, thumbnail generation, the codec to use._

* A *Profile* specifies a big part of the configuration used by an *Encore* Job - metadata, FFmpeg configuration and specific codec configuration.
* A *Profile* is specified in the yaml-format.

==== Scaling, distribution and queues

_By using Redis (as a message broker/queue handler) and an internal concurrency scheduler, *Encore* can be scaled by setting up more instances, and allowing more concurrency._

* An *Encore* instance uses Redis through Redisson's  https://javadoc.io/doc/org.redisson/redisson/3.7.5/org/redisson/RedissonPriorityBlockingQueue.html[_Priority Blocking Queue_]. Jobs are scheduled on an *Encore* instance according to a given priority.
* Furthermore, The *Encore* concurrency setting affects how many transcoding jobs be run on the same instance at once.

_So, From an *Encore* instance's point of view, the next Encore Job is chosen for transcoding according to its priority and according to how many concurrent tasks that are allowed on that instance._

image::img/svt_encore_queue.png[align="center",width=90%]

[[apiendpoints]]
=== API/Endpoints

*Encore* is built using the framework Spring Rest Data  https://docs.spring.io/spring-data/rest/docs/current/reference/html/#repository-resources.fundamentals[offering the default endpoints] generated from the usage of this framework.
However, other custom Endpoints exist.

*Encore's* endpoints are described and self-documented in the https://www.openapis.org/[OpenAPIv3 format].

==== Dynamically generated Endpoint documentation

To see and interact with the endpoints live, consult your

https://YOUR_RUNNING_ENCORE_INSTANCE/swagger-ui.html

TIP: This is the recommended way - dynamic, powerful and
always up-to-date.

.Encore OpenAPI
image::img/svt_encore_api.png[align="center",width=90%]

==== Statically generated Endpoint documentation

To see a static version, refer to the xref:openapi.adoc[Static Endpoints] documentation.

CAUTION: The statically generated documentation needs to be cleaned up, as it is autogenerated, with quite a few quirks.
This will happen when the project is mature.

=== Models

==== Encore Job

The Encore Job is a central object in Encore.
The Encore Job fields are described in the <<dynamically-generated-endpoint-documentation>>, but also in the

xref:openapi.adoc#_encorejob[EncoreJob static documentation]

.The Encore Job class in Kotlin (click to expand)
[%collapsible]
====
[source,kotlin]
----
include::https://raw.githubusercontent.com/svt/encore/master/src/main/kotlin/se/svt/oss/encore/model/EncoreJob.kt[]
----
====

image::img/svt_encore_job_processing.png[align="center",width=90%]

==== Profile

NOTE: See the <<profiles>> section in the Appendix for concrete <<profile>> examples.

A *Profile* consists of toplevel metadata, and a list of encoding configuration types - _encodes_.

.Profile metadata
[grid=none,frame=sides]
|===
| Field | Description | Constraint | Default

| name
| profile name
|
|

| description
| a helpful description of the profile
|
|

| scaling
| directly matching the FFmpeg scaling algorithm options
| if given, one of the https://ffmpeg.org/ffmpeg-scaler.html[FFmpeg Scaling algorithm options]
| lanczos

| encodes
| a list of encode types (configurations) for the profile
|

<<audioencode,AudioEncode>>
<<videoencode,X264Encode>>
<<videoencode,X265Encode>>
<<thumbnailencode,ThumbnailEncode>>
<<thumbnailmapencode,ThumbnailMapEncode>>

|
|===

==== Profile Encode Types

include::encodes.adoc[]


